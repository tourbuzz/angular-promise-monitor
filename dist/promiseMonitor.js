// Generated by CoffeeScript 1.7.1
angular.module('promiseMonitor', []).factory('$promiseMonitor', [
  '$q', function($q) {
    var monitorDefered, notify, promises;
    promises = {};
    monitorDefered = $q.defer();
    notify = function(promiseScope) {
      if (promiseScope == null) {
        promiseScope = 'default';
      }
      return monitorDefered.notify(promises[promiseScope].length);
    };
    return {
      regiesterPromise: function(p, promiseScope) {
        if (promiseScope == null) {
          promiseScope = 'default';
        }
        promises[promiseScope] || (promises[promiseScope] = []);
        promises[promiseScope].push(p);
        notify(promiseScope);
        return promise["finally"](function() {
          promises[promiseScope].splice(promises[promiseScope].indexOf(p), 1);
          return notify(promiseScope);
        });
      },
      pending: function(promiseScope) {
        if (promiseScope == null) {
          promiseScope = 'default';
        }
        return promises[promiseScope].length;
      },
      promise: function() {
        return monitorDefered.promise;
      }
    };
  }
]).directive('promiseMonitorEnabled', [
  '$promiseMonitor', function($promiseMonitor) {
    return {
      restrict: 'A',
      link: function(scope, elem, attrs) {
        var promiseScope;
        promiseScope = attrs.promiseMonitorScope != null ? attrs.promiseMonitorScope : 'default';
        return $promiseMonitor.promise(promiseMonitorScope).then(null, null, function(outstandingCount) {
          if (outstandingCount) {
            return attrs.disabled = true;
          } else {
            return attrs.disabled = false;
          }
        });
      }
    };
  }
]).directive('promiseMonitorStatus', [
  '$promiseMonitor', function($promiseMonitor) {
    return {
      restrict: 'A',
      link: function(scope, elem, attrs) {
        var promiseScope;
        promiseScope = attrs.promiseMonitorScope != null ? attrs.promiseMonitorScope : 'default';
        return $promiseMonitor.promise(promiseScope).then(null, null, function(outstandingCount) {
          if (outstandingCount) {
            return elem.html("" + outstandingCount + " jobs pending");
          } else {
            return elem.html('');
          }
        });
      }
    };
  }
]);
